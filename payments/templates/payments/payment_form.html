 {% extends 'base.html' %}
{% load static %}
{% block title %}ثبت سفارش و پرداخت{% endblock %}
{% block content %}
<h3>ثبت سفارش و پرداخت</h3>
<form method="post" id="payment-form">
    {% csrf_token %}
    <table class="table table-bordered" id="order-table">
        <thead>
            <tr>
                <th>نام محصول</th>
                <th>قیمت (تومان)</th>
                <th>تعداد</th>
                <th>جمع</th>
                <th>حذف</th>
            </tr>
        </thead>
        <tbody id="order-items">
            <!-- آیتم‌ها با جاوااسکریپت اضافه می‌شوند -->
        </tbody>
    </table>

    <select id="menu-select" class="form-select mb-3">
        <option value="">انتخاب محصول...</option>
        {% for item in menu_items %}
        <option value="{{ item.id }}" data-price="{{ item.price }}">{{ item.name }} - {{ item.price }} تومان</option>
        {% endfor %}
    </select>

    <div>
        <strong>جمع کل: </strong><span id="total-price">0</span> تومان
    </div>

    {{ form.as_p }}

    <button type="submit" class="btn btn-success mt-3">ثبت سفارش</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const menuSelect = document.getElementById('menu-select');
    const orderItems = document.getElementById('order-items');
    const totalPriceEl = document.getElementById('total-price');

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('#order-items tr').forEach(row => {
            const price = parseFloat(row.dataset.price);
            const qty = parseInt(row.querySelector('input[type="number"]').value);
            total += price * qty;
            row.querySelector('.subtotal').textContent = price * qty;
        });
        totalPriceEl.textContent = total;
    }

    menuSelect.addEventListener('change', () => {
        const selectedOption = menuSelect.selectedOptions[0];
        if (!selectedOption.value) return;

        // چک کن اگر آیتم قبلا اضافه شده
        if ([...orderItems.querySelectorAll('tr')].some(row => row.dataset.id === selectedOption.value)) {
            alert('این محصول قبلاً اضافه شده است.');
            return;
        }

        const tr = document.createElement('tr');
        tr.dataset.id = selectedOption.value;
        tr.dataset.price = selectedOption.dataset.price;

        tr.innerHTML = `
            <td>${selectedOption.textContent}</td>
            <td>${selectedOption.dataset.price}</td>
            <td><input type="number" name="quantities[]" value="1" min="1" style="width:60px;"></td>
            <td class="subtotal">${selectedOption.dataset.price}</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-btn">حذف</button></td>
            <input type="hidden" name="items[]" value="${selectedOption.value}">
        `;

        orderItems.appendChild(tr);

        updateTotal();

        tr.querySelector('input[type="number"]').addEventListener('change', () => {
            updateTotal();
        });

        tr.querySelector('.remove-btn').addEventListener('click', () => {
            tr.remove();
            updateTotal();
        });
    });

    // فرم قبل ارسال چک کن حداقل یک محصول وجود داشته باشه
    document.getElementById('payment-form').addEventListener('submit', e => {
        if (orderItems.children.length === 0) {
            e.preventDefault();
            alert('لطفا حداقل یک محصول انتخاب کنید.');
        }
    });
});
</script>
{% endblock %}